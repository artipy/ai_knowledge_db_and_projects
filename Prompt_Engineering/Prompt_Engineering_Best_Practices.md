# Лучшие практики Prompt Engineering

## Введение

**Prompt Engineering** — это процесс формулирования сообщений для языковой модели таким образом, чтобы получить наилучший результат за один промпт. Основной принцип: **качественные входные данные → качественные выходные данные**.

## Основные компоненты

### Роли в Chat API

Каждый endpoint работает с тремя типами ролей:

1. **System (Системная роль)** — управляет поведением модели на протяжении всего диалога
2. **User (Роль пользователя)** — под этой ролью отправляются запросы к модели
3. **Assistant (Роль ассистента)** — под этой ролью модель возвращает ответы

### Ключевые параметры API

**`temperature`** — управляет случайностью в ответах (0–2):
- `0` — полностью детерминированные ответы (высокая воспроизводимость)
- `1` — сбалансированная креативность (значение по умолчанию)
- `2` — максимальная случайность (для творческих задач)

**`max_completion_tokens`** — ограничивает максимальную длину ответа в токенах

```python
from openai import OpenAI
import os

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def get_response(prompt, temperature=1.0):
    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=temperature,
        max_completion_tokens=500
    )
    return response.choices[0].message.content
```

---

## Три ключевых принципа Prompt Engineering

### 1. Используйте глаголы действия

**✅ Рекомендуемые глаголы**:
- Напиши
- Сгенерируй
- Резюмируй
- Закончи
- Объясни
- Опиши
- Выполни
- Преобразуй
- Извлеки

**❌ Избегайте абстрактных глаголов**:
- Подумай
- Знай
- Почувствуй
- Попробуй
- Поразмысли

**Пример**:
```
❌ Плохо: "Подумай о преимуществах Python"
✅ Хорошо: "Перечисли пять основных преимуществ языка Python"
```

### 2. Предоставляйте детальные и точные инструкции

Определяйте:
- **Контекст** — предыстория или ситуация
- **Длину ответа** — количество пунктов, слов, параграфов
- **Формат и стиль** — таблица, список, формальный/неформальный тон
- **Целевую аудиторию** — эксперты, новички, дети

**Пример**:
```
❌ Плохо: "Расскажи про машинное обучение"

✅ Хорошо: "Объясни концепцию машинного обучения для начинающих программистов.
Используй простые аналогии и приведи 2-3 конкретных примера применения.
Ответ должен быть в формате списка, длиной не более 200 слов."
```

### 3. Структурируйте промпты по разделам

Хорошо структурированный промпт содержит:
- **Роль** — кем должна быть модель
- **Границы** — что можно и нельзя делать
- **Входные данные** — выделенные разделителями (тройные обратные кавычки)
- **Формат вывода** — как должен выглядеть результат

**Пример структурированного промпта**:
```python
text = "Искусственный интеллект меняет мир..."

role = "Ты опытный технический редактор."

boundaries = """
Ограничения:
- НЕ добавляй информацию, которой нет в тексте
- НЕ используй эмодзи
- Сохраняй исходный смысл
"""

instruction = "Сократи текст в два раза, сохранив ключевые идеи."

prompt = f"{role}\n\n{boundaries}\n\n{instruction}\n\nТекст:\n```\n{text}\n```"
```

---

## Структурированные ответы

LLM не создают структурированные документы автоматически — формат нужно явно указывать в промпте.

### Таблицы

Для создания таблицы укажите заголовки столбцов и при необходимости их описание.

**Пример**:
```python
prompt = """Создай таблицу с 5 фильмами в жанре action.
В таблице должны быть следующие столбцы:
- Название фильма
- Год выпуска
- Рейтинг IMDb"""

print(get_response(prompt))
```

**Результат**:
| Название фильма | Год выпуска | Рейтинг IMDb |
|----------------|-------------|--------------|
| Mad Max: Fury Road | 2015 | 8.1 |
| John Wick | 2014 | 7.4 |
| ... | ... | ... |

### Списки

Существует два типа списков: нумерованные и ненумерованные.

**Пример нумерованного списка** (по умолчанию):
```python
prompt = "Сгенерируй список из топ-5 городов мира для туризма"
print(get_response(prompt))
```

**Результат**:
1. Париж, Франция
2. Токио, Япония
3. Нью-Йорк, США
4. Рим, Италия
5. Барселона, Испания

**Для ненумерованного списка** явно укажите это в промпте:
```python
prompt = "Создай ненумерованный список из 5 преимуществ удаленной работы"
```

### Структурированные параграфы

Для создания структурированного текста укажите требуемые заголовки и подзаголовки.

**Пример**:
```python
prompt = """Создай структурированный параграф с понятными заголовками и подзаголовками
на тему: польза регулярных тренировок для здоровья человека."""

print(get_response(prompt))
```

**Результат**:
```
# Польза регулярных тренировок

## Физическое здоровье
### Укрепление сердечно-сосудистой системы
...
### Контроль веса
...

## Психологическое здоровье
### Снижение стресса
...
```

### Пользовательский формат

Для создания собственного формата разбейте промпт на логические части.

**Пример**:
```python
text = "Однажды в маленькой тихой деревне жил любопытный мальчик по имени Дэвид..."

instruction = """Тебе предоставляется текст, выделенный в тройные обратные кавычки.
Сгенерируй подходящее название для этого текста."""

output_format = """Используй следующий формат для ответа:
- Текст: <первые 50 символов исходного текста>
- Название: <сгенерированное название>
- Жанр: <определенный жанр>"""

prompt = f"{instruction}\n\n{output_format}\n\n```{text}```"

print(get_response(prompt))
```

**Результат**:
```
- Текст: Однажды в маленькой тихой деревне жил любопытны...
- Название: Приключения любопытного Дэвида
- Жанр: Детская приключенческая литература
```

---

## Условная логика в промптах

Вы можете встроить логику проверок, чтобы модель выполняла действия при определенных условиях.

### Простое условие

**Пример**:
```python
text = "The quick brown fox jumps over the lazy dog"

prompt = f"""Тебе предоставляется текст, выделенный в тройные обратные кавычки.
Сгенерируй подходящее название для этого текста только если текст написан на русском языке.
В противном случае ответь "Простите, я понимаю только русский текст".

```{text}```"""

print(get_response(prompt))
# Вывод: Простите, я понимаю только русский текст
```

### Множественные условия

**Пример**:
```python
text = "История про слона, который научился летать..."

prompt = f"""Тебе предоставляется текст, выделенный в тройные обратные кавычки.

Условия:
1. Если текст написан на русском языке, проверь наличие ключевого слова "слон"
2. Если оба условия выполняются, придумай подходящее название для текста
3. Если текст написан НЕ на русском языке, ответь "Простите, я понимаю только русский текст"
4. Если в тексте нет ключевого слова "слон", ответь "Ключевое слово не найдено"

```{text}```"""

print(get_response(prompt))
# Вывод: "Летающий слон" или подобное название
```

---

## Практические рекомендации

### 1. Итеративная разработка промптов

Не ожидайте идеального результата с первой попытки. Улучшайте промпт итеративно:

```
Версия 1: "Напиши про Python"
Версия 2: "Объясни основные преимущества Python"
Версия 3: "Объясни 3 основных преимущества Python для начинающих программистов"
Версия 4: "Объясни 3 основных преимущества Python для начинающих программистов.
           Для каждого преимущества приведи конкретный пример кода."
```

### 2. Используйте разделители

Четко выделяйте входные данные с помощью разделителей:
- Тройные обратные кавычки: ` ``` `
- XML-подобные теги: `<input>...</input>`
- Маркеры: `###`, `---`, `===`

### 3. Указывайте примеры (Few-shot learning)

Покажите модели несколько примеров желаемого результата:

```python
prompt = """Преобразуй адрес электронной почты в следующий формат:

Пример 1:
Вход: john.doe@example.com
Выход: {"user": "john.doe", "domain": "example.com"}

Пример 2:
Вход: alice_smith@company.org
Выход: {"user": "alice_smith", "domain": "company.org"}

Теперь преобразуй:
Вход: bob.wilson@startup.io"""
```

### 4. Управление temperature

- **Факты, анализ, код** → `temperature=0` (детерминированность)
- **Общие задачи** → `temperature=0.7` (баланс)
- **Креативное письмо, брейнсторминг** → `temperature=1.5-2.0` (креативность)

### 5. Проверяйте и тестируйте

Тестируйте промпты на различных входных данных:
- Обычные случаи
- Граничные случаи (пустой текст, очень длинный текст)
- Некорректные данные (чтобы проверить условную логику)

---

## Анти-паттерны (чего избегать)

❌ **Слишком общие инструкции**
```
"Расскажи что-нибудь интересное"
```

❌ **Отсутствие контекста**
```
"Объясни это" (без указания, что именно)
```

❌ **Противоречивые требования**
```
"Ответь очень кратко и детально"
```

❌ **Неясные ограничения**
```
"Не делай ничего плохого" (слишком расплывчато)
```

❌ **Игнорирование формата вывода**
```
Ожидание JSON, но не указание этого в промпте
```

---

## Шаблон универсального промпта

```python
def create_prompt(
    role: str,
    task: str,
    input_data: str,
    output_format: str,
    constraints: list[str] = None,
    examples: list[dict] = None
) -> str:
    """
    Создает структурированный промпт по шаблону.

    Args:
        role: Роль модели (например, "Ты опытный аналитик данных")
        task: Основное задание (например, "Проанализируй текст")
        input_data: Входные данные
        output_format: Описание формата вывода
        constraints: Список ограничений
        examples: Примеры входных и выходных данных

    Returns:
        Форматированный промпт
    """
    prompt_parts = [role, "", task]

    if constraints:
        prompt_parts.append("\nОграничения:")
        for constraint in constraints:
            prompt_parts.append(f"- {constraint}")

    if examples:
        prompt_parts.append("\nПримеры:")
        for i, example in enumerate(examples, 1):
            prompt_parts.append(f"\nПример {i}:")
            prompt_parts.append(f"Вход: {example['input']}")
            prompt_parts.append(f"Выход: {example['output']}")

    prompt_parts.append(f"\n{output_format}")
    prompt_parts.append(f"\nВходные данные:\n```\n{input_data}\n```")

    return "\n".join(prompt_parts)


# Использование
prompt = create_prompt(
    role="Ты эксперт по обработке текста.",
    task="Извлеки ключевые слова из текста.",
    input_data="Машинное обучение — это подмножество искусственного интеллекта...",
    output_format="Верни результат в формате JSON со списком ключевых слов.",
    constraints=[
        "Не более 5 ключевых слов",
        "Только существительные"
    ]
)
```

---

## Связанные материалы

- [[OpenAI_API/Working_with_OpenAI_API_in_Python|Работа с OpenAI API в Python]]
- [[OpenAI_API/Chat_Roles_and_Multi_Turn_Conversations|Роли в чатах и многоэтапные диалоги]]
- [[OpenAI_API/Introduction_to_OpenAI_API|Введение в OpenAI API]]
- [[Exercises/03_Prompt_Engineering_Exercise|Практическое задание №3]] - отработка лучших практик prompt engineering на практике

---

## Ресурсы для углубленного изучения

- [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)
- [Anthropic Prompt Engineering Guide](https://docs.anthropic.com/claude/docs/prompt-engineering)
- [Learn Prompting - Free Course](https://learnprompting.org/)

---

**Ключевой вывод**: Качественный промпт = Четкая роль + Конкретная задача + Структурированный формат + Явные ограничения
